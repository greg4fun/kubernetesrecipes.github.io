---
import { SEO } from "astro-seo";
import Footer from "@components/footer.astro";
import Navbar from "@components/navbar/navbar.astro";
import AnnouncementBanner from "@components/announcement-banner.astro";
import "@fontsource-variable/inter/index.css";
import "@fontsource-variable/bricolage-grotesque";
import "../styles/global.css";

export interface Props {
  title?: string;
  description?: string;
  image?: string;
  type?: "website" | "article";
  publishDate?: Date;
  modifiedDate?: Date;
  author?: string;
  readingTime?: number;
  tags?: string[];
}

// ============================================
// ANNOUNCEMENT BANNER CONFIGURATION
// Set enabled to false to hide the banner
// ============================================
const announcementConfig = {
  enabled: true,
  emoji: "ðŸŽ¤",
  headline: "Speaking at KubeCon EU 2026",
  description: "Lessons Learned Orchestrating Multi-Tenant GPUs on OpenShift AI",
  linkText: "View Session",
  linkUrl: "https://kccnceu2026.sched.com/event/2CVzs/lessons-learned-orchestrating-multi-tenant-gpus-on-openshift-ai-with-nvidia-kai-gh200-luca-berton-dell-technologies",
  gradientFrom: "cyan-600",
  gradientVia: "blue-600",
  gradientTo: "purple-600",
};
// ============================================

// ============================================
// CANONICAL URL - Critical for SEO
// Must match trailingSlash config in astro.config.mjs
// ============================================
const siteUrl = "https://kubernetes.recipes";
const pathname = Astro.url.pathname === '/'
  ? '/'
  : Astro.url.pathname.endsWith('/') ? Astro.url.pathname : `${Astro.url.pathname}/`;
const canonicalURL = `${siteUrl}${pathname}`;

const { 
  title, 
  description = "Kubernetes Recipe Book is a curated collection of Kubernetes recipes to simplify container orchestration and cluster management.",
  image = "/opengraph.jpg",
  type = "website",
  publishDate,
  modifiedDate,
  author = "Luca Berton",
  readingTime = 5,
  tags = ["Kubernetes", "DevOps", "Cloud Native"]
} = Astro.props;

const resolvedImageWithDomain = new URL(image, siteUrl).toString();

const siteName = "Kubernetes Recipe Book";
const makeTitle = title
  ? `${title} | ${siteName}`
  : "Kubernetes Recipe Book - A Practical Guide for Container Orchestration";

// Current date for modified if not provided
const lastModified = modifiedDate || publishDate || new Date();

// ============================================
// STRUCTURED DATA - Article/TechArticle Schema
// ============================================
const articleStructuredData = type === "article" ? {
  "@context": "https://schema.org",
  "@type": "TechArticle",
  "@id": `${canonicalURL}#article`,
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": canonicalURL
  },
  "headline": title,
  "description": description,
  "image": {
    "@type": "ImageObject",
    "url": resolvedImageWithDomain,
    "width": 1200,
    "height": 630
  },
  "datePublished": publishDate?.toISOString(),
  "dateModified": lastModified.toISOString(),
  "author": {
    "@type": "Person",
    "name": author,
    "url": `${siteUrl}/authors`
  },
  "publisher": {
    "@type": "Organization",
    "name": siteName,
    "url": siteUrl,
    "logo": {
      "@type": "ImageObject",
      "url": `${siteUrl}/favicon.svg`,
      "width": 512,
      "height": 512
    }
  },
  "keywords": tags.join(", "),
  "articleSection": "Technology",
  "inLanguage": "en-US",
  "isAccessibleForFree": true,
  "license": "https://creativecommons.org/licenses/by/4.0/"
} : null;

// Website structured data (for non-article pages)
const websiteStructuredData = type === "website" ? {
  "@context": "https://schema.org",
  "@type": "WebSite",
  "@id": `${siteUrl}#website`,
  "name": siteName,
  "description": description,
  "url": siteUrl,
  "publisher": {
    "@type": "Organization",
    "name": siteName,
    "@id": `${siteUrl}#organization`
  },
  "potentialAction": {
    "@type": "SearchAction",
    "target": {
      "@type": "EntryPoint",
      "urlTemplate": `${siteUrl}/recipes?q={search_term_string}`
    },
    "query-input": "required name=search_term_string"
  },
  "inLanguage": "en-US"
} : null;

// Book structured data for homepage
const bookStructuredData = {
  "@context": "https://schema.org",
  "@type": "Book",
  "@id": `${siteUrl}#book`,
  "name": "Kubernetes Recipes",
  "alternateName": "Kubernetes Recipe Book",
  "author": [
    {
      "@type": "Person",
      "name": "Luca Berton",
      "url": `${siteUrl}/authors`,
      "sameAs": [
        "https://twitter.com/lucab85",
        "https://linkedin.com/in/lucaberton",
        "https://github.com/lucab85"
      ]
    },
    {
      "@type": "Person", 
      "name": "Grzegorz Stencel",
      "url": `${siteUrl}/authors`
    }
  ],
  "isbn": "979-8-8688-1324-5",
  "numberOfPages": 750,
  "publisher": {
    "@type": "Organization",
    "name": "Apress",
    "url": "https://www.apress.com"
  },
  "datePublished": "2025-04-01",
  "inLanguage": "en",
  "image": resolvedImageWithDomain,
  "description": "A Practical Guide for Container Orchestration and Deployment",
  "bookFormat": "https://schema.org/Paperback",
  "genre": ["Technology", "Computer Science", "Cloud Computing"],
  "about": {
    "@type": "Thing",
    "name": "Kubernetes",
    "sameAs": "https://en.wikipedia.org/wiki/Kubernetes"
  },
  "offers": {
    "@type": "Offer",
    "url": "https://amzn.to/3DzC8QA",
    "availability": "https://schema.org/InStock",
    "priceCurrency": "USD",
    "seller": {
      "@type": "Organization",
      "name": "Amazon"
    }
  }
};

// Organization structured data
const organizationStructuredData = {
  "@context": "https://schema.org",
  "@type": "Organization",
  "@id": `${siteUrl}#organization`,
  "name": siteName,
  "url": siteUrl,
  "logo": {
    "@type": "ImageObject",
    "url": `${siteUrl}/favicon.svg`,
    "width": 512,
    "height": 512
  },
  "description": "A practical guide to Kubernetes container orchestration with real-world recipes and best practices.",
  "sameAs": [
    "https://twitter.com/lucab85",
    "https://github.com/kubernetesrecipes",
    "https://linkedin.com/in/lucaberton"
  ],
  "contactPoint": {
    "@type": "ContactPoint",
    "contactType": "customer support",
    "url": `${siteUrl}/contact`,
    "availableLanguage": "English"
  },
  "founder": {
    "@type": "Person",
    "name": "Luca Berton"
  }
};

// Breadcrumb structured data (dynamic based on URL path)
const pathSegments = pathname.split('/').filter(Boolean);
const breadcrumbItems = pathSegments.map((segment, index) => {
  const itemUrl = `${siteUrl}/${pathSegments.slice(0, index + 1).join('/')}`;
  const name = segment.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
  return {
    "@type": "ListItem",
    "position": index + 2,
    "name": name,
    "item": itemUrl
  };
});

const breadcrumbStructuredData = pathSegments.length > 0 ? {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": siteUrl
    },
    ...breadcrumbItems
  ]
} : null;

// FAQ Schema for recipe pages (improves SERP features)
const isRecipePage = pathname.includes('/recipes/') && pathSegments.length >= 3;
const faqStructuredData = isRecipePage ? {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": [
    {
      "@type": "Question",
      "name": `What is ${title}?`,
      "acceptedAnswer": {
        "@type": "Answer",
        "text": description
      }
    }
  ]
} : null;

// HowTo Schema for recipe pages
const howToStructuredData = isRecipePage ? {
  "@context": "https://schema.org",
  "@type": "HowTo",
  "name": title,
  "description": description,
  "image": resolvedImageWithDomain,
  "totalTime": `PT${readingTime}M`,
  "tool": [
    {
      "@type": "HowToTool",
      "name": "kubectl"
    },
    {
      "@type": "HowToTool",
      "name": "Kubernetes cluster"
    }
  ]
} : null;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <meta name="theme-color" content="#3b82f6" />
    <meta name="generator" content={Astro.generator} />
    
    <!-- ============================================ -->
    <!-- CANONICAL URL - Critical for SEO -->
    <!-- ============================================ -->
    <link rel="canonical" href={canonicalURL} />
    
    <!-- ============================================ -->
    <!-- SEO Meta Tags - Pro Level -->
    <!-- ============================================ -->
    <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1" />
    <meta name="googlebot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
    <meta name="bingbot" content="index, follow" />
    
    <!-- Author & Publisher -->
    <meta name="author" content={author} />
    <meta name="publisher" content={siteName} />
    <meta name="copyright" content={`Â© ${new Date().getFullYear()} ${siteName}`} />
    
    <!-- Content Info -->
    <meta name="keywords" content={tags.join(", ") + ", Kubernetes, K8s, container orchestration, DevOps, cloud native, Docker, microservices, deployment, pods, services, Helm, kubectl"} />
    <meta name="subject" content="Kubernetes Container Orchestration" />
    <meta name="topic" content="Technology" />
    <meta name="classification" content="Technology/Cloud Computing" />
    <meta name="coverage" content="Worldwide" />
    <meta name="distribution" content="Global" />
    <meta name="rating" content="General" />
    
    <!-- Date metadata -->
    {publishDate && <meta name="date" content={publishDate.toISOString().split('T')[0]} />}
    {publishDate && <meta name="article:published_time" content={publishDate.toISOString()} />}
    <meta name="article:modified_time" content={lastModified.toISOString()} />
    
    <!-- Sitemap & RSS -->
    <link rel="sitemap" href="/sitemap-index.xml" />
    
    <!-- Preconnect to external domains for performance -->
    <link rel="preconnect" href="https://www.googletagmanager.com" />
    <link rel="preconnect" href="https://www.google-analytics.com" />
    <link rel="preconnect" href="https://cdn.jsdelivr.net" />
    <link rel="dns-prefetch" href="https://www.googletagmanager.com" />
    <link rel="dns-prefetch" href="https://www.google-analytics.com" />
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" />

    <SEO
      title={makeTitle}
      description={description}
      canonical={canonicalURL}
      openGraph={{
        basic: {
          url: canonicalURL,
          type: type === "article" ? "article" : "website",
          title: makeTitle,
          image: resolvedImageWithDomain,
        },
        optional: {
          siteName: siteName,
          locale: "en_US",
          description: description,
        },
        image: {
          alt: title ? `${title} - Kubernetes Recipe` : "Kubernetes Recipe Book Cover",
          width: 1200,
          height: 630,
          type: "image/jpeg",
          secureUrl: resolvedImageWithDomain,
        },
        ...(type === "article" && publishDate && {
          article: {
            publishedTime: publishDate.toISOString(),
            modifiedTime: lastModified.toISOString(),
            authors: [`${siteUrl}/authors`],
            section: "Technology",
            tags: tags,
          },
        }),
      }}
      twitter={{
        card: "summary_large_image",
        site: "@lucab85",
        creator: "@lucab85",
        title: makeTitle,
        description: description,
        image: resolvedImageWithDomain,
        imageAlt: title ? `${title} - Kubernetes Recipe` : "Kubernetes Recipe Book Cover",
      }}
      extend={{
        link: [
          { rel: "me", href: "https://twitter.com/lucab85" },
          { rel: "me", href: "https://github.com/lucab85" },
        ],
        meta: [
          { name: "twitter:label1", content: "Written by" },
          { name: "twitter:data1", content: author },
          { name: "twitter:label2", content: "Est. reading time" },
          { name: "twitter:data2", content: `${readingTime} min read` },
          { property: "article:author", content: author },
          { name: "apple-mobile-web-app-title", content: siteName },
          { name: "application-name", content: siteName },
        ],
      }}
    />
    
    <!-- ============================================ -->
    <!-- Structured Data - Rich Snippets -->
    <!-- ============================================ -->
    {articleStructuredData && (
      <script type="application/ld+json" set:html={JSON.stringify(articleStructuredData)} />
    )}
    {websiteStructuredData && (
      <script type="application/ld+json" set:html={JSON.stringify(websiteStructuredData)} />
    )}
    <script type="application/ld+json" set:html={JSON.stringify(organizationStructuredData)} />
    {pathname === '' && (
      <script type="application/ld+json" set:html={JSON.stringify(bookStructuredData)} />
    )}
    {breadcrumbStructuredData && (
      <script type="application/ld+json" set:html={JSON.stringify(breadcrumbStructuredData)} />
    )}
    {howToStructuredData && (
      <script type="application/ld+json" set:html={JSON.stringify(howToStructuredData)} />
    )}
    <!-- Mermaid Diagrams -->
    <script type="module">
      import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
      mermaid.initialize({ 
        startOnLoad: false,
        theme: 'neutral',
        securityLevel: 'loose',
        flowchart: {
          useMaxWidth: true,
          htmlLabels: true,
          curve: 'basis'
        }
      });
      
      // Find all mermaid code blocks and render them
      document.addEventListener('DOMContentLoaded', async () => {
        // Astro/Shiki renders as: <pre class="astro-code" data-language="mermaid">
        const codeBlocks = document.querySelectorAll('pre[data-language="mermaid"]');
        
        for (let i = 0; i < codeBlocks.length; i++) {
          const pre = codeBlocks[i];
          // Get text content from the code element inside
          const code = pre.querySelector('code');
          const content = code ? code.textContent : pre.textContent;
          
          // Create a container for the rendered diagram
          const container = document.createElement('div');
          container.className = 'mermaid-diagram my-6 flex justify-center';
          
          try {
            const { svg } = await mermaid.render(`mermaid-${i}`, content.trim());
            container.innerHTML = svg;
            pre.replaceWith(container);
          } catch (e) {
            console.error('Mermaid rendering error:', e);
          }
        }
        
        // Also handle any pre-existing .mermaid elements
        await mermaid.run();
      });
    </script>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-CCC31PP3QS"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-CCC31PP3QS');
    </script>
    <!-- Microsoft Clarity -->
    <script type="text/javascript">
      (function(c,l,a,r,i,t,y){
          c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
          t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
          y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
      })(window, document, "clarity", "script", "v5mvt15y9u");
    </script>
    <meta name="google-site-verification" content="9cz9zIJrUCY3p9QQOW8TjKiM329bHY1iwwsLNyvx51w" />
  </head>
  <body>
    <AnnouncementBanner {...announcementConfig} />
    <Navbar />
    <slot />
    <Footer />
    <style is:global>
      /* Improve Page speed */
      /* https://css-tricks.com/almanac/properties/c/content-visibility/ */
      img {
        content-visibility: auto;
      }
    </style>
  </body>
</html>
